<?xml version="1.0" encoding="UTF-8"?>
<root BTCPP_format="4"
      main_tree_to_execute="newfindball">
  <BehaviorTree ID="findnewballtest">
    <RetryUntilSuccessful num_attempts="-1">
      <Sequence>
        <SetIntakeMechanism dribble="3"
                            lift="0.3"/>
        <Sequence>
          <ReactiveFallback>
            <BallGrabbed color="blue"/>
            <GrabNearestBall color="blueball"
                             id="{id}"/>
            <Repeat num_cycles="3">
              <Sequence>
                <NavToPose frame_id="map"
                           goal="9.5;2.0;-1.0"/>
                <Sleep msec="2000"/>
                <NavToPose frame_id="map"
                           goal="9.5;2.0;-2.07"/>
              </Sequence>
            </Repeat>
          </ReactiveFallback>
          <ReactiveFallback>
            <BallGrabbed color="blue"/>
            <BallGrabbed color="purple"/>
            <Follow color="blueball"
                    id="{id}"/>
          </ReactiveFallback>
          <FollowPose frame_id="base_link"
                      goal="0;0;0"/>
        </Sequence>
        <Fallback>
          <BallGrabbed color="blue"/>
          <ForceFailure>
            <Sequence>
              <Rotate pose=""
                      angle="-2.5"
                      rotated_pose=""
                      frame_id=""/>
              <Sleep msec="1000"/>
              <SetIntakeMechanism dribble="0"
                                  lift="2"/>
              <GetIntakeProximityArray pattern="000"/>
              <Rotate pose=""
                      angle="-1.57"
                      rotated_pose=""
                      frame_id=""/>
              <Sleep msec="1000"/>
              <SetIntakeMechanism dribble="3"
                                  lift="0.5"/>
            </Sequence>
          </ForceFailure>
        </Fallback>
        <GetIntakeProximityArray pattern="010"/>
        <SetIntakeMechanism dribble="0"
                            lift="0"/>
      </Sequence>
    </RetryUntilSuccessful>
  </BehaviorTree>

  <BehaviorTree ID="grabball">
    <ReactiveFallback>
      <Fallback>
        <BallGrabbed color="blue"/>
        <BallGrabbed color="purple"/>
        <GrabNearestBall color="blueball"
                         id="{id}"/>
      </Fallback>
      <Repeat num_cycles="-1">
        <Sequence>
          <NavToPose frame_id="map"
                     goal="9.5;1.0;-0.8"/>
          <Sleep msec="1000"/>
          <NavToPose frame_id="map"
                     goal="9.5;1.0;-2.3"/>
        </Sequence>
      </Repeat>
    </ReactiveFallback>
  </BehaviorTree>

  <BehaviorTree ID="intakenew">
    <Sequence>
      <SetIntakeMechanism dribble="3"
                          lift="0.8"/>
      <GetBallGrabbed color_output=""
                      color_input="blue"/>
      <SetIntakeMechanism dribble="0"
                          lift="0.5"/>
      <FollowPose frame_id="base_link"
                  goal="0;0;0"/>
      <GetBallGrabbedTop color="blue"/>
      <SetIntakeMechanism dribble="0"
                          lift="0"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="maintree">
    <SequenceWithMemory>
      <SubTree ID="movetest"/>
      <Repeat num_cycles="9">
        <Sequence>
          <SubTree ID="findandfollowball"
                   _autoremap="true"/>
          <Sleep msec="1000"/>
          <SubTree ID="silo2"/>
          <SubTree ID="outtake"
                   _autoremap="false"/>
          <NavThroughPoses frame_id="map"
                           goals="9.5;0.8;-1.57"/>
          <SubTree ID="findandfollowball"
                   _autoremap="true"/>
          <Sleep msec="1000"/>
          <SubTree ID="silo3"/>
          <SubTree ID="outtake"
                   _autoremap="false"/>
          <NavThroughPoses frame_id="map"
                           goals="9.5;0.8;-1.57"/>
          <SubTree ID="findandfollowball"/>
          <Sleep msec="1000"/>
          <SubTree ID="silo4"/>
          <SubTree ID="outtake"/>
          <NavThroughPoses frame_id="map"
                           goals="9.5;0.8;-1.57"/>
        </Sequence>
      </Repeat>
    </SequenceWithMemory>
  </BehaviorTree>

  <BehaviorTree ID="movenew">
    <Sequence>
      <WaitButton/>
      <NavThroughPoses frame_id="map"
                       goals="4.8;0.0;-3.14 /&#10;5.2;0.1;-3.14 /&#10;5.6;0.4;-3.14 /&#10;5.9;0.8;-3.14 /&#10;6.2;3.74;-1.57"/>
      <NavThroughPoses frame_id="map"
                       goals="8.0;3.74;-1.57/&#10;8.4;3.45;-1.57 /&#10;8.5;3.25;-1.57 /&#10;8.7;3.05;-1.57 /&#10;9.0;2.0;-1.57 /&#10;10.0;0.0;-1.57"/>
      <NavThroughPoses frame_id="map"
                       goals="9.5;2.0;-1.57"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="movepivot">
    <NavThroughPoses frame_id="map"
                     goals="8.70;2.0;-1.57 /&#10;8.70;3.0;-1.57"/>
  </BehaviorTree>

  <BehaviorTree ID="movetest">
    <Sequence>
      <NavThroughPoses frame_id="map"
                       goals="5.1;0.0;3.14 /&#10;5.3;0.1;3.14 /&#10;5.4;0.2;3.14 /&#10;5.6;0.4;3.14 /&#10;5.8;0.8;3.14 /&#10;6.0;3.74;3.14"/>
      <NavThroughPoses frame_id="map"
                       goals="8.0;3.74;3.14/&#10;8.4;3.45;-1.75 /&#10;8.5;3.25;-1.57 /&#10;8.7;3.05;-1.57 /&#10;9.0;2.5;-1.57 /&#10;9.5;0.8;-1.57"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="newfindandfollow">
    <Sequence>
      <Parallel failure_count="1"
                success_count="-1">
        <SubTree ID="oldfindnewball"/>
        <SubTree ID="intakenew"/>
      </Parallel>
      <NavToPose frame_id="base_link"
                 goal="0;0;0"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="newfindball">
    <RetryUntilSuccessful num_attempts="-1">
      <Sequence>
        <SetIntakeMechanism dribble="3"
                            lift="0.5"/>
        <Fallback>
          <BallGrabbed color="blue"/>
          <ForceFailure>
            <Sequence>
              <BallGrabbed color="purple"/>
              <SubTree ID="rotateToTarget"
                       _autoremap="true"/>
            </Sequence>
          </ForceFailure>
          <Sequence>
            <BallGrabbed color="null"/>
            <SubTree ID="grabball"
                     _autoremap="true"/>
            <ReactiveFallback>
              <BallGrabbed color="blue"/>
              <BallGrabbed color="purple"/>
              <Follow color="blueball"
                      id="{id}"/>
            </ReactiveFallback>
          </Sequence>
        </Fallback>
        <BallGrabbed color="blue"/>
        <GetIntakeProximityArray pattern="100"/>
        <SetIntakeMechanism dribble="3"
                            lift="0"/>
        <NavToPose frame_id="base_link"
                   goal="0;0;0"/>
      </Sequence>
    </RetryUntilSuccessful>
  </BehaviorTree>

  <BehaviorTree ID="newintake">
    <RetryUntilSuccessful num_attempts="-1">
      <Sequence>
        <SetIntakeMechanism dribble="1"
                            lift="0.5"/>
        <Fallback>
          <BallGrabbed color="blue"/>
          <BallGrabbed color="purple"/>
        </Fallback>
        <GetIntakeProximityArray pattern="010"/>
        <SetIntakeMechanism dribble="0"
                            lift="0"/>
      </Sequence>
    </RetryUntilSuccessful>
  </BehaviorTree>

  <BehaviorTree ID="newnew">
    <Sequence>
      <WaitButton/>
      <Sequence>
        <Repeat num_cycles="3">
          <Sequence>
            <SubTree ID="newfindball"
                     _autoremap="false"/>
            <SubTree ID="silo2"
                     _autoremap="false"/>
            <SubTree ID="outtake"/>
            <NavThroughPoses frame_id="map"
                             goals="9.5;3.0;-1.57"/>
          </Sequence>
        </Repeat>
        <Repeat num_cycles="3">
          <Sequence>
            <SubTree ID="newfindball"/>
            <SubTree ID="silo3"/>
            <SubTree ID="outtake"/>
            <NavThroughPoses frame_id="map"
                             goals="9.5;3.0;-1.57"/>
          </Sequence>
        </Repeat>
        <Repeat num_cycles="3">
          <Sequence>
            <SubTree ID="newfindball"
                     _autoremap="false"/>
            <SubTree ID="silo4"/>
            <SubTree ID="outtake"/>
            <NavThroughPoses frame_id="map"
                             goals="9.5;3.0;-1.57"/>
          </Sequence>
        </Repeat>
      </Sequence>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="oldfindnewball">
    <RetryUntilSuccessful num_attempts="-1">
      <Sequence>
        <ReactiveFallback>
          <BallGrabbed color="blue"/>
          <GrabNearestBall color="blueball"
                           id="{id}"/>
          <Repeat num_cycles="3">
            <Sequence>
              <NavToPose frame_id="map"
                         goal="9.5;2.0;-1.0"/>
              <Sleep msec="2000"/>
              <NavToPose frame_id="map"
                         goal="9.5;2.0;-2.07"/>
            </Sequence>
          </Repeat>
        </ReactiveFallback>
        <ReactiveFallback>
          <BallGrabbed color="blue"/>
          <Follow color="blueball"
                  id="{id}"/>
        </ReactiveFallback>
        <FollowPose frame_id="base_link"
                    goal="0;0;0"/>
      </Sequence>
    </RetryUntilSuccessful>
  </BehaviorTree>

  <BehaviorTree ID="optimizedfindball">
    <Sequence>
      <SetBlackboard value="NULL"
                     output_key="ball_state"/>
      <BallGrabbed color="{ball_state}"/>
      <SubTree ID="rotateToTarget"
               _autoremap="true"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="outtake">
    <Sequence>
      <SetIntakeMechanism dribble="0"
                          lift="0.8"/>
      <GetIntakeProximityArray pattern="001"/>
      <GetIntakeProximityArray pattern="000"/>
      <SetIntakeMechanism dribble="0"
                          lift="0"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="reactivetest">
    <ReactiveFallback>
      <GetBallGrabbed color_output=""
                      color_input="blue"/>
      <AMCLUpdate/>
    </ReactiveFallback>
  </BehaviorTree>

  <BehaviorTree ID="repeattest">
    <Sequence>
      <Repeat num_cycles="1">
        <SubTree ID="silo1"/>
      </Repeat>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="rotateToTarget">
    <Sequence>
      <GetIntakeProximityArray pattern="010"/>
      <SetIntakeMechanism dribble="0"
                          lift="0"/>
      <GetCurrentPose parent_frame_id="map"
                      child_frame_id="base_link"
                      pose="{outpose}"
                      x="{prev_x}"
                      y="{prev_y}"
                      theta="{prev_theta}"/>
      <RotateSpeed speed="6.0"
                   angle="0.0"/>
      <SetIntakeMechanism dribble="0.0"
                          lift="2.0"/>
      <GetBallGrabbedTop color="purple"/>
      <GetIntakeProximityArray pattern="000"/>
      <RotateSpeed speed="6.0"
                   angle="{prev_theta}"/>
      <SetIntakeMechanism dribble="3"
                          lift="0.5"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="silo1">
    <Sequence>
      <NavThroughPoses frame_id="map"
                       goals="7.95;3.0;-1.57 /&#10;7.95;4.0;-1.57"/>
      <AMCLUpdate/>
      <NavToPose frame_id="map"
                 goal="7.95;4.8;-1.57"/>
      <AMCLUpdate/>
      <FollowPose frame_id="map"
                  goal="7.95;5.1;-1.57"/>
      <Sleep msec="1000"/>
      <NavToPose frame_id="base_link"
                 goal="0;0;0"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="silo2">
    <Sequence>
      <NavThroughPoses frame_id="map"
                       goals="8.70;3.0;-1.57"/>
      <AMCLUpdate/>
      <NavToPose frame_id="map"
                 goal="8.70;4.8;-1.57"/>
      <FollowPose frame_id="map"
                  goal="8.70;5.1;-1.57"/>
      <Sleep msec="1000"/>
      <NavToPose frame_id="base_link"
                 goal="0;0;0"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="silo3">
    <Sequence>
      <NavThroughPoses frame_id="map"
                       goals="9.45;3.0;-1.57"/>
      <AMCLUpdate/>
      <NavToPose frame_id="map"
                 goal="9.45;4.8;-1.57"/>
      <FollowPose frame_id="map"
                  goal="9.45;5.1;-1.57"/>
      <Sleep msec="1000"/>
      <NavToPose frame_id="base_link"
                 goal="0;0;0"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="silo4">
    <Sequence>
      <NavThroughPoses frame_id="map"
                       goals="10.23;3.0;-1.57"/>
      <AMCLUpdate/>
      <NavToPose frame_id="map"
                 goal="10.23;4.8;-1.57"/>
      <FollowPose frame_id="map"
                  goal="10.23;5.1;-1.57"/>
      <Sleep msec="1000"/>
      <NavToPose frame_id="base_link"
                 goal="0;0;0"/>
    </Sequence>
  </BehaviorTree>

  <BehaviorTree ID="silotest">
    <Sequence>
      <NavToPose frame_id="map"
                 goal="9.5 ;0.5;-1.57"/>
      <NavToPose frame_id="map"
                 goal="9.5 ;2.0;-1.57"/>
      <Repeat num_cycles="-1">
        <Sequence>
          <SubTree ID="newfindball"/>
          <NavToPose frame_id="map"
                     goal="9.5;3.0;-1.57"/>
          <SubTree ID="outtake"/>
        </Sequence>
      </Repeat>
    </Sequence>
  </BehaviorTree>

  <!-- Description of Node Models (used by Groot) -->
  <TreeNodesModel>
    <Action ID="AMCLUpdate"
            editable="true"/>
    <Condition ID="BallGrabbed"
               editable="true">
      <input_port name="color"/>
    </Condition>
    <Action ID="Follow"
            editable="true">
      <input_port name="color"/>
      <input_port name="id"/>
    </Action>
    <Condition ID="FollowPose"
               editable="true">
      <input_port name="frame_id"/>
      <input_port name="goal"/>
    </Condition>
    <Action ID="GetBallGrabbed"
            editable="true">
      <output_port name="color_output"/>
      <input_port name="color_input"/>
    </Action>
    <Action ID="GetBallGrabbedTop"
            editable="true">
      <input_port name="color"/>
    </Action>
    <Action ID="GetCurrentPose"
            editable="true">
      <input_port name="parent_frame_id"/>
      <input_port name="child_frame_id"/>
      <output_port name="pose"/>
      <output_port name="x"/>
      <output_port name="y"/>
      <output_port name="theta"/>
    </Action>
    <Action ID="GetIntakeProximityArray"
            editable="true">
      <input_port name="pattern"/>
    </Action>
    <Condition ID="GrabNearestBall"
               editable="true">
      <input_port name="color"/>
      <output_port name="id"/>
    </Condition>
    <Action ID="NavThroughPoses"
            editable="true">
      <input_port name="frame_id"/>
      <input_port name="goals"/>
    </Action>
    <Action ID="NavToPose"
            editable="true">
      <input_port name="frame_id"/>
      <input_port name="goal"/>
    </Action>
    <Action ID="Rotate"
            editable="true">
      <input_port name="pose"/>
      <input_port name="angle"/>
      <output_port name="rotated_pose"/>
      <input_port name="frame_id"/>
    </Action>
    <Action ID="RotateSpeed"
            editable="true">
      <input_port name="speed"/>
      <input_port name="angle"/>
    </Action>
    <Condition ID="SetIntakeMechanism"
               editable="true">
      <input_port name="dribble"/>
      <input_port name="lift"/>
    </Condition>
    <Action ID="WaitButton"
            editable="true"/>
  </TreeNodesModel>

</root>
